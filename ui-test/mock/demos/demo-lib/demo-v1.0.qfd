# type: STEP
# version: 1.0
# desc: common demo step logic
# author: Qore Technologies, s.r.o.
%new-style
%require-types
%strict-args
%enable-all-warnings

const PropNameDisableErrors = "disable-errors";

sub demo() {
    hash<auto> sh = wf_get_step_info();

    # 1/20 chance of a delay once in the order
    if (!(rand() % 20) && !wf_get_dynamic_data("delay-done")) {
        log(LL_INFO, "delaying execution for 1 second");
        wf_update_dynamic_data({"delay-done": True});
        omqsleep(1);
    }

    if (wf_get_dynamic_data("disable-errors")) {
        log(LL_INFO, "static data value %y set (step %s v%s (%d))", PropNameDisableErrors, sh.name, sh.version, sh.stepid);
        return;
    }

    if (wf_get_static_data("disable-errors")) {
        log(LL_INFO, "dynamic data value %y set (step %s v%s (%d))", PropNameDisableErrors, sh.name, sh.version, sh.stepid);
        return;
    }

    if (prop_get("demo", PropNameDisableErrors)) {
        log(LL_INFO, "system property %y set in the \"demo\" domain (step %s v%s (%d))", PropNameDisableErrors, sh.name, sh.version, sh.stepid);
        return;
    }

    # 1/10 chance of a retry error if errors are not disabled
    if (!(rand() % 10)) {
        log(LL_INFO, "raising a random technical error for step %s v%s (%d)", sh.name, sh.version, sh.stepid);
        wf_serror("RETRY-ERROR", "random technical error", 2);
        return;
    }

    log(LL_INFO, "no errors for step %s v%s (%d)", sh.name, sh.version, sh.stepid);
}
# END

# type: VALIDATION
# version: 1.0
# desc: demo validation function
# author: Qore Technologies, s.r.o.
%new-style
%require-types
%strict-args
%enable-all-warnings

string sub demo_val() {
    hash<auto> sh = wf_get_step_info();
    log(LL_INFO, "recovered step %s v%s (%d) automatically", sh.name, sh.version, sh.stepid);
    return OMQ::StatComplete;
}
# END

# type: STEP
# version: 1.0
# desc: common demo step logic
# author: Qore Technologies, s.r.o.
%new-style
%require-types
%strict-args
%enable-all-warnings

sub demo_async() {
    wf_skip_async_step();
}
# END

# type: ASYNC-END
# version: 1.0
# desc: demo async end function
# author: Qore Technologies, s.r.o.
%new-style
%require-types
%strict-args
%enable-all-warnings

sub demo_end(auto x) {
}
# END