# -*- mode: qore; indent-tabs-mode: nil -*-

# servicetype: USER
# service: opc-milo-client-demo
# serviceversion: 1.0
# servicedesc: demonstrates OPC API support with the open-source Milo SDK
# autostart: true
# parse-options: PO_NEW_STYLE, PO_STRICT_ARGS, PO_REQUIRE_TYPES
# define-group: DEMO: demonstration code
# groups: DEMO
# ENDSERVICE

# name: init
# desc: initializes the service
%enable-all-warnings

%requires jni

%module-cmd(jni) add-classpath $OMQ_DIR/user/jar/google-collections-1.0.jar
%module-cmd(jni) add-classpath $OMQ_DIR/user/jar/jool-0.9.10.jar
%module-cmd(jni) add-classpath $OMQ_DIR/user/jar/sdk-client-0.1.3-SNAPSHOT.jar
%module-cmd(jni) add-classpath $OMQ_DIR/user/jar/slf4j-api-1.7.21.jar
%module-cmd(jni) add-classpath $OMQ_DIR/user/jar/stack-client-0.1.3-SNAPSHOT.jar
%module-cmd(jni) add-classpath $OMQ_DIR/user/jar/stack-core-0.1.3-SNAPSHOT.jar
%module-cmd(jni) add-classpath $OMQ_DIR/user/jar/stack-server-0.1.3-SNAPSHOT.jar

%module-cmd(jni) import java.security.KeyStore
%module-cmd(jni) import java.security.PrivateKey
%module-cmd(jni) import java.security.cert.X509Certificate
%module-cmd(jni) import java.util.ArrayList
%module-cmd(jni) import java.util.Arrays
%module-cmd(jni) import java.util.EnumSet
%module-cmd(jni) import java.util.List
%module-cmd(jni) import java.util.Random
%module-cmd(jni) import java.util.concurrent.CompletableFuture
%module-cmd(jni) import java.util.concurrent.ExecutionException
%module-cmd(jni) import java.util.concurrent.TimeUnit
%module-cmd(jni) import java.util.concurrent.atomic.AtomicBoolean
%module-cmd(jni) import java.util.concurrent.atomic.AtomicInteger
%module-cmd(jni) import java.util.function.BiConsumer

%module-cmd(jni) import com.google.common.collect.ImmutableList
%module-cmd(jni) import org.eclipse.milo.opcua.sdk.client.api.UaSession
%module-cmd(jni) import org.eclipse.milo.opcua.sdk.client.api.config.OpcUaClientConfig
%module-cmd(jni) import org.eclipse.milo.opcua.sdk.client.api.identity.UsernameProvider
%module-cmd(jni) import org.eclipse.milo.opcua.sdk.client.api.identity.X509IdentityProvider
%module-cmd(jni) import org.eclipse.milo.opcua.sdk.client.api.nodes.VariableNode
%module-cmd(jni) import org.eclipse.milo.opcua.sdk.client.api.subscriptions.UaMonitoredItem
%module-cmd(jni) import org.eclipse.milo.opcua.sdk.client.api.subscriptions.UaSubscription
%module-cmd(jni) import org.eclipse.milo.opcua.sdk.client.api.subscriptions.UaSubscriptionManager

class QorusUaClient inherits UaClient {
    constructor(string url) : UaClient(url) {
        setSecurityMode(SecurityMode::NONE);
        initialize();
    }

    destructor() {
        disconnect();
    }

    private:internal initialize() {
        ApplicationDescription appDescription();
        appDescription.setApplicationName(new LocalizedText("QorusOpcClient", Locale::ENGLISH));
        appDescription.setApplicationUri("urn:localhost:UA:QorusOpcClient");
        appDescription.setProductUri("urn:prosysopc.com:UA:QorusOpcClient");
        appDescription.setApplicationType(ApplicationType::Client);

        ApplicationIdentity identity();
        identity.setApplicationDescription(appDescription);
        setApplicationIdentity(identity);
    }
}

sub init() {
    our QorusUaClient client("opc.tcp://localhost:52520/OPCUA/SampleConsoleServer");
    client.connect();
}
# END

# desc: read the server's state
string sub read() {
    DataValue value = client.readValue(Identifiers::Server_ServerStatus_State);
    string rv = value.toString();
    log(LL_INFO, "value: %y", rv);
    return rv;
}
# END
