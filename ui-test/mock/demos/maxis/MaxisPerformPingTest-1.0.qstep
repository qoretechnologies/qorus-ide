%new-style
%strict-args
%require-types
%enable-all-warnings

class MaxisPerformPingTest inherits QorusNormalStep {
    primary() {
        int status;
        string msg;
        if (*softint dd_status = getStaticData("ping_status")) {
            status = dd_status;
        } else {
            switch ((rand() % 10)) {
                case < 1:
                    status = 3;
                    break;

                case < 3:
                    status = 2;
                    break;

                default:
                    status = 1;
                    break;
            }
        }

        hash<auto> info;
        switch (status) {
            case 1:
                msg = "OK: Latency and connectivity check completed with no warnings or errors and no lost packets";
                int ping = (rand() % 10) + 10;
                info = {
                    "ping-test": {
                        "title": "Latency and Connectivity Test",
                        "detail": sprintf("OK: %dms average latency, no lost packets", ping),
                    },
                };
                break;

            case 2:
                msg = "WARNING: Latency and connectivity check completed with warnings indicating degraded performance";
                int ping = (rand() % 200) + 200;
                int dropped = 1;
                info = {
                    "ping-test": {
                        "title": "Latency and Connectivity Test",
                        "detail": sprintf("%dms average latency, %d/20 lost packets (%g%% packet loss)", ping, dropped, (dropped.toFloat() / 20.0) * 100),
                    },
                };
                break;

            case 3:
                msg = "ERROR: Latency and connectivity check detected packet loss and latency below the minimum threshold";
                int ping = (rand() % 10) + 500;
                int dropped = (rand() % 5) + 5;
                info = {
                    "ping-test": {
                        "title": "Latency and Connectivity Test",
                        "detail": sprintf("%dms average latency, %d/20 lost packets (%g%% packet loss)", ping, dropped, (dropped.toFloat() / 20.0) * 100),
                    },
                };
                break;
        }

        updateDynamicData({
            ("step" + getStepInfo().stepid): {
                "status": status,
                "message": msg,
                "metadata": info,
            },
        });
    }
}
