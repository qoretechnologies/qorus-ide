job:
    name:
        db-orders-to-erp
    desc:
        Create new orders in the ERP system from the `orders` table
    classes:
        BBM_AutoMapper
        BBM_OutputData

    config:
        automapper-mapper-name:
            db-orders-to-erp-mapper

        automapper-input-search:
            {creation_date: {op: ">", arg: "$pstate:last_executed??{$parse-value:{1970-01-01}}"}}

        output-data-hash:
            {"$info:started": "$pstate:last_executed"}

    mappers:
        db-orders-to-erp-mapper
        db-orders-to-erp-item-mapper

    mapper:
        name:
            db-orders-to-erp-mapper
        desc:
            Create new orders in the ERP system from the `orders` table
        input:
            datasource -> omquser -> orders
        output:
            connection -> zeyosrests-iot-demo -> api -> v1 -> transactions -> PUT -> request
        mappings:
            assigneduser:
                constant: 3
            type
                constant: 6
            status
                constant: 0
            transactionnum ⬅︎ order_id
            account ⬅︎ account
            netamount ⬅︎ cost
            margin ⬅︎ markup
            currency ⬅︎ currency_code
            shippingrecipient ⬅︎ ext_account_id
            items:
                submapper: db-orders-to-erp-item-mapper
                submapper_options: {input_provider_search: {order_id: '$local:input.order_id'}}
                submapper_auto_input: true

    mapper:
        name:
            db-orders-to-erp-item-mapper
        desc:
            Create new items in the ERP system from the `order_items` table
        input:
            datasource -> omquser -> order_items
        output:
            type -> zeyos -> order -> item
        mappings:
            type:
                constant: 0
            amount:
                ⬅︎ quantity
            itemnum:
                ⬅︎ item_id
            purchaseprice:
                ⬅︎ cost
            sellingprice:
                context: $qore-expr:{$local:input.cost + $local:input.markup}