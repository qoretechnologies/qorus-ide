<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE ixml SYSTEM "http://www.ixmldev.com/schema/ixml.dtd">
<ixml>

<!-- Get the current month and year -->
<date:format format="m" var="month" />
<date:format format="y" var="year" />

<!-- Set the timeframe to 6 month -->
<set var="timeframe">6</set>

<array var="labels" />
<array var="series" />

<array var="values" />

<!-- Cycle over the past 6 month -->
<for var="i" from="$($timeframe * -1 + 1)" to="0">
  <!-- See the schema documentation for details: http://schema.zeyos.com/tables/transactions.html -->
  <db:select var_result="events" type="assoc">
    <db:fields>
      <db:field>name</db:field>
      <db:field>date</db:field>
      <db:field>description</db:field>
      <db:field>status</db:field>
	  <db:field>effort</db:field>
    </db:fields>
    <db:table>actionsteps</db:table>
    <db:is field="status">1</db:is> <!-- Only completed -->
    <db:is field="name">PMA: Qore Technology</db:is>
    <db:is field="date" func="&gt;=">
      <date:create day="1" month="$($month + $i)" year="$year" var="start" />
    </db:is>
    <db:is field="date" func="&lt;">
      <date:create day="1" month="$($month + $i + 1)" year="$year" />
    </db:is>
    <db:orderby>
      <db:orderfield>date</db:orderfield>
    </db:orderby>
  </db:select>

  <debug:dump var="events"/>

  <!-- Create the label from the start date -->
  <!--<date:format format="m/Y" var="labels[]">$start</date:format>-->

  <!-- Initialize the values -->
  <foreach var="events" var_value="event">
    <decode:json var="evt_data">$event.description</decode:json>

    <!-- Skip events with bad format -->
    <array:keyexists var="evt_data" var_result="result">values</array:keyexists>
    <is var="result" type="false">
      <next/> <!-- continue -->
    </is>

    <!-- Add date as a label -->
    <!-- TODO: change unix timestamp into actual date -->
    <array:push var="labels">$event.date</array:push>

    <!-- debug prints -->
    <!--<debug:dump var="event" />
    <debug:dump var="evt_data" />-->

    <!-- Extract values from the event into evt_values -->
    <!--<array var="evt_values" />-->

    <array var="evt_key_arr" />
    <array var="evt_val_arr" />
    <foreach var="evt_data" var_key="ed_key" var_value="ed_val">
      <!--<debug:dump var="ed_key"/>
      <debug:dump var="ed_val"/>-->
      <debug:output>outside if</debug:output>
      <if value1="$ed_key" func="=" value2="values"> <!-- ignore the orig key -->
        <debug:output>inside if</debug:output>
        <!--<array:push var="evt_values">$ed_val</array:push>-->
        <!--<array:concat var="evt_values" var_tail="ed_val"/>-->
        <!--<set var="evt_values" key="$ed_key">$ed_val</set>-->
        <set var="evt_key_arr[]">$ed_key</set>
        <!--<array:push var="evt_key_arr">$ed_key</array:push>-->
        <set var="evt_val_arr[]">$ed_val</set>
        <!--<array:push var="evt_val_arr">$ed_val</array:push>-->
      </if> 
    </foreach>
    <!--<debug:dump var="evt_key_arr"/>
    <debug:dump var="evt_val_arr"/>-->
    <array:assoc var="evt_values" var_keys="evt_key_arr" var_values="evt_val_arr"/>

    <debug:dump var="evt_values"/>
    <foreach var="evt_values" var_key="ts_key" var_value="ts_val">
      <array:keyexists var="values" var_result="result">ts_key</array:keyexists>
      <is var="result" type="true">
        <array:push var="values[$ts_key][]">$ts_val</array:push>
        <else>
          <array var="val_arr">
            <item>$ts_val</item>
          </array>
          <assign var="values[$ts_key][]" var_source="val_arr"/>
        </else>
      </is>
    </foreach>
  </foreach>

  <debug:dump var="values"/>

    <!--<foreach var="$evt_data.records" var_value="record">
      <array:keyexists var="record" var_result="result">taskState</array:keyexists>
      <is var="result" type="true">
        <array:length var="$record.taskState" var_result="len"/>
        <if value1="len" value2="1">
          <set var="record_state">$record.taskState[0]</set>
          <else>
            <set var="record_state">null</set>
          </else>
        </if>
      </is>
      <if value1="result" value2="$status">
        <set var="value">$invoice.revenue</set>
        <break />
      </if>
      <array:push var="chart_data[$record.title]">$record.taskState[0].value</array:push>
      <if value1="$invoice.status" value2="$status">
        <set var="value">$invoice.revenue</set>
        <break />
      </if>
    </foreach>-->

    <!--<set var="value">0</set>
    <foreach var="events" var_value="event">
      <if value1="$invoice.status" value2="$status">
        <set var="value">$invoice.revenue</set>
        <break />
      </if>
    </foreach>
    <cast var="value" type="float" />
    <assign var="series[$key][]" var_source="value" />
  </foreach>-->
</for>

<output>
  <include id="chartist-line-chart">
    <param name="labels">
      <encode:json var="labels" />
    </param>
    <param name="series">
      <encode:json var="values" />
    </param>
    <param name="events">
      <encode:json var="events" />
    </param>
  </include>
</output>

</ixml>
